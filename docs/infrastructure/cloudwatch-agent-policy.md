# CloudWatch Agent ì ìš© ì •ì±… (í™˜ê²½ë³„)

> Dev/Prod í™˜ê²½ë³„ CloudWatch Agent í™œì„±í™” ì „ëµ ë° ë¹„ìš© ë¶„ì„

---

## 1. í™˜ê²½ë³„ ì ìš© ì •ì±… ìš”ì•½

| ìŠ¤íƒ | Dev | Prod | ì´ìœ  |
|:---|:---:|:---:|:---|
| **15-teleport** | âœ… | âœ… | ë³´ì•ˆ ê°ì‚¬ ë¡œê·¸ í•„ìˆ˜ |
| **30-bastion** | âŒ | âš ï¸ | Dev: SSM ì¶©ë¶„ / Prod: ì„ íƒì  |
| **50-rke2** | âŒ | âŒ | Prometheus + Grafana ì‚¬ìš© (K8s í‘œì¤€) |
| **60-db** | âœ… | âœ… | ì¥ì•  ë¶„ì„ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í•„ìˆ˜ |
| **40-harbor** | âš ï¸ | âœ… | Dev: ì„ íƒì  / Prod: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¤‘ìš” |

---

## 2. ìƒì„¸ ì ìš© ì „ëµ

### 2.1 Development í™˜ê²½

#### âœ… í™œì„±í™” (2~3ê°œ ìŠ¤íƒ)

**15-teleport (Teleport ì„œë²„)**
```yaml
ì´ìœ :
  - ë³´ì•ˆ ì ‘ê·¼ ì œì–´ì˜ í•µì‹¬ ì¸í”„ë¼
  - ì„¸ì…˜ ë¡œê·¸ ë° ì¸ì¦ ì‹¤íŒ¨ ì¶”ì  í•„ìš”
  - Break Glass ìƒí™© ê°ì‚¬ í•„ìˆ˜

ë¡œê·¸:
  - /var/log/secure (ì¸ì¦ ë¡œê·¸)
  - /var/log/teleport/*.log (Teleport ì•± ë¡œê·¸)

ë©”íŠ¸ë¦­:
  - CPU, Memory, Disk

ë³´ê´€ ê¸°ê°„: 7ì¼
ì›” ë¹„ìš©: ~$25 (2ëŒ€ HA)
```

**60-db (Database ì„œë²„)**
```yaml
ì´ìœ :
  - ê°œë°œ ì¤‘ DB ì„±ëŠ¥ ì´ìŠˆ ë””ë²„ê¹…
  - ì¿¼ë¦¬ ìŠ¬ë¡œìš° ë¡œê·¸ ë¶„ì„
  - ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

ë¡œê·¸:
  - /var/log/messages (ì‹œìŠ¤í…œ)
  - Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ (PostgreSQL, Neo4j)

ë©”íŠ¸ë¦­:
  - CPU, Memory, Disk, Docker Stats

ë³´ê´€ ê¸°ê°„: 3ì¼ (ë¹„ìš© ì ˆê°)
ì›” ë¹„ìš©: ~$20 (2ëŒ€)
```

#### âŒ ë¹„í™œì„±í™”

**30-bastion**
```yaml
ì´ìœ :
  - ë‹¨ìˆœ Jump Host (ì• í”Œë¦¬ì¼€ì´ì…˜ ì—†ìŒ)
  - SSM Session Managerë¡œ ì§ì ‘ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
  - íŠ¸ë˜í”½/ë¡œê·¸ ë³¼ë¥¨ ë§¤ìš° ì ìŒ

ëŒ€ì•ˆ: AWS SSM Session Manager
ì ˆê°: ~$12/ì›”
```

**50-rke2 (Kubernetes ë…¸ë“œ)**
```yaml
ì´ìœ :
  - Prometheus + Grafanaë¡œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (K8s í‘œì¤€)
  - kubectl logsë¡œ Pod ë¡œê·¸ ì¡°íšŒ
  - Node ë¡œê·¸ëŠ” í•„ìš” ì‹œ SSM ì ‘ì†

ëŒ€ì•ˆ:
  - Prometheus (ë©”íŠ¸ë¦­)
  - Loki / ELK (ë¡œê·¸, í•„ìš” ì‹œ)
  - SSM (Node SSH)

ì ˆê°: ~$87/ì›” (7ëŒ€)
```

**40-harbor (ê°œë°œ í™˜ê²½)**
```yaml
ì´ìœ :
  - ê°œë°œìš© ë ˆì§€ìŠ¤íŠ¸ë¦¬ëŠ” í¬ë¦¬í‹°ì»¬í•˜ì§€ ì•ŠìŒ
  - Harbor UIì—ì„œ ìì²´ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥

ëŒ€ì•ˆ: Harbor Web UI, SSM
ì ˆê°: ~$12/ì›”
```

#### ğŸ’° Dev í™˜ê²½ ì´ ë¹„ìš©

```
í™œì„±í™”: 15-teleport (2ëŒ€) + 60-db (2ëŒ€) = 4ëŒ€
ì›” ë¹„ìš©: ~$45

ì ˆê°ì•¡: ~$111 (ë¹„í™œì„±í™” 8ëŒ€)
```

---

### 2.2 Production í™˜ê²½

#### âœ… í™œì„±í™” (ëª¨ë“  ìŠ¤íƒ)

**15-teleport**
```yaml
ë¡œê·¸ ë³´ê´€: 30ì¼
ì•ŒëŒ:
  - ì¸ì¦ ì‹¤íŒ¨ > 10íšŒ/5ë¶„
  - CPU > 80%
  - Memory > 85%
  - Disk > 90%

ì›” ë¹„ìš©: ~$35 (2ëŒ€ + ì¥ê¸° ë³´ê´€)
```

**60-db**
```yaml
ë¡œê·¸ ë³´ê´€: 30ì¼
ì•ŒëŒ:
  - DB ì»¨í…Œì´ë„ˆ Down
  - ì¿¼ë¦¬ ì‘ë‹µ ì‹œê°„ > 500ms
  - CPU > 70%
  - Memory > 80%
  - Disk > 85%

ì›” ë¹„ìš©: ~$30 (2ëŒ€ + ì¥ê¸° ë³´ê´€)
```

**50-rke2**
```yaml
ì ìš©: ì„ íƒì  (Prometheus ë³´ì™„ìš©)

ë¡œê·¸:
  - /var/log/messages (ì‹œìŠ¤í…œ í¬ë¦¬í‹°ì»¬ë§Œ)
  - kubelet ë¡œê·¸ (ERRORë§Œ)

ë©”íŠ¸ë¦­:
  - Node CPU, Memory, Disk (Prometheus ë°±ì—…)

ë³´ê´€ ê¸°ê°„: 14ì¼
ì›” ë¹„ìš©: ~$50 (7ëŒ€, í•„í„°ë§)
```

**30-bastion**
```yaml
ì ìš©: ì„ íƒì 

ë¡œê·¸:
  - /var/log/secure (ì ‘ê·¼ ê¸°ë¡)

ë³´ê´€ ê¸°ê°„: 90ì¼ (ì»´í”Œë¼ì´ì–¸ìŠ¤)
ì›” ë¹„ìš©: ~$8 (ë¡œê·¸ë§Œ, ë©”íŠ¸ë¦­ ì œì™¸)
```

**40-harbor**
```yaml
ì ìš©: í•„ìˆ˜

ë¡œê·¸:
  - Harbor ì•± ë¡œê·¸
  - Registry í‘¸ì‹œ/í’€ ë¡œê·¸

ì•ŒëŒ:
  - ìŠ¤í† ë¦¬ì§€ > 85%
  - ì´ë¯¸ì§€ í’€ ì‹¤íŒ¨ > 5íšŒ/10ë¶„

ë³´ê´€ ê¸°ê°„: 30ì¼
ì›” ë¹„ìš©: ~$15
```

#### ğŸ’° Prod í™˜ê²½ ì´ ë¹„ìš©

```
ì™„ì „ í™œì„±í™”: ëª¨ë“  ìŠ¤íƒ (12ëŒ€)
ì›” ë¹„ìš©: ~$138

ì„ íƒì  í™œì„±í™”: í•„ìˆ˜ë§Œ (Teleport, DB, Harbor)
ì›” ë¹„ìš©: ~$80
```

---

## 3. í™˜ê²½ë³„ ë¹„ìš© ë¹„êµí‘œ

| í™˜ê²½ | í™œì„±í™” ìŠ¤íƒ | ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ | ì›” ë¹„ìš© | ì ˆê°ì•¡ |
|:---|:---|:---:|:---:|:---:|
| **Dev (ê¶Œì¥)** | Teleport, DB | 4 | $45 | $111 |
| **Dev (ìµœì†Œ)** | Teleportë§Œ | 2 | $25 | $131 |
| **Prod (ì™„ì „)** | ì „ì²´ | 12 | $138 | - |
| **Prod (ì„ íƒ)** | í•„ìˆ˜ë§Œ | 6 | $80 | $58 |

---

## 4. êµ¬í˜„ ë°©ë²• (Terraform)

### 4.1 í™˜ê²½ë³„ ë³€ìˆ˜ ì„¤ì •

```hcl
# stacks/dev/env.tfvars
enable_cloudwatch_agent = false  # ê¸°ë³¸ ë¹„í™œì„±í™” (Dev)

# ìŠ¤íƒë³„ ì˜¤ë²„ë¼ì´ë“œ
cloudwatch_enabled_stacks = ["15-teleport", "60-db"]

# stacks/prod/env.tfvars
enable_cloudwatch_agent = true   # ê¸°ë³¸ í™œì„±í™” (Prod)
```

### 4.2 user-data ì¡°ê±´ë¶€ í™œì„±í™”

```bash
# user-data.sh
ENABLE_CLOUDWATCH=${enable_cloudwatch}

if [ "$ENABLE_CLOUDWATCH" = "true" ]; then
  echo "[CloudWatch] Enabling CloudWatch Agent"
  systemctl enable amazon-cloudwatch-agent
  systemctl start amazon-cloudwatch-agent
else
  echo "[CloudWatch] Disabled (cost optimization)"
  systemctl disable amazon-cloudwatch-agent
  systemctl stop amazon-cloudwatch-agent
fi
```

---

## 5. ë¡œê·¸ ë³´ê´€ ì •ì±…

### 5.1 í™˜ê²½ë³„ ê¸°ë³¸ê°’

| í™˜ê²½ | ì‹œìŠ¤í…œ ë¡œê·¸ | ë³´ì•ˆ ë¡œê·¸ | ì•± ë¡œê·¸ |
|:---|:---:|:---:|:---:|
| **Dev** | 3ì¼ | 7ì¼ | 3ì¼ |
| **Prod** | 14ì¼ | 90ì¼ | 30ì¼ |

### 5.2 ë¹„ìš© ì˜í–¥

```
ì˜ˆì‹œ: 60-db ì„œë²„ 1ëŒ€

Dev (3ì¼):
  - ìˆ˜ì§‘: 1.5 GB Ã— $0.76 = $1.14
  - ì €ì¥: 1.5 GB Ã— $0.033 / 30 Ã— 3 = $0.005
  - ì´: ~$1.15/ì›”

Prod (30ì¼):
  - ìˆ˜ì§‘: 15 GB Ã— $0.76 = $11.40
  - ì €ì¥: 15 GB Ã— $0.033 = $0.50
  - ì´: ~$11.90/ì›”

ì°¨ì´: 10ë°°
```

---

## 6. ì•ŒëŒ ì •ì±… (Prodë§Œ)

| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì¡°ì¹˜ |
|:---|:---|:---|
| **CPU** | 80% (5ë¶„ ì§€ì†) | SNS ì•ŒëŒ â†’ Slack |
| **Memory** | 85% (3ë¶„ ì§€ì†) | SNS ì•ŒëŒ |
| **Disk** | 90% | Critical ì•ŒëŒ + PagerDuty |
| **DB ë‹¤ìš´** | ì»¨í…Œì´ë„ˆ ì¤‘ì§€ | Immediate ì•ŒëŒ |

---

## 7. ìµœì¢… ê¶Œì¥ì‚¬í•­

### Dev í™˜ê²½
```yaml
í™œì„±í™”:
  - 15-teleport: âœ… (ë³´ì•ˆ ê°ì‚¬)
  - 60-db: âœ… (ë””ë²„ê¹…)

ë¹„í™œì„±í™”:
  - 30-bastion: âŒ (SSM ì‚¬ìš©)
  - 50-rke2: âŒ (Prometheus ì‚¬ìš©)
  - 40-harbor: âŒ (Harbor UI ì‚¬ìš©)

ë¹„ìš©: $45/ì›”
ì ˆê°: $111/ì›” (71% ì ˆê°)
```

### Prod í™˜ê²½
```yaml
í•„ìˆ˜ í™œì„±í™”:
  - 15-teleport: âœ…
  - 60-db: âœ…
  - 40-harbor: âœ…

ì„ íƒ í™œì„±í™”:
  - 50-rke2: âš ï¸ (Prometheus ë³´ì™„ìš©)
  - 30-bastion: âš ï¸ (ì»´í”Œë¼ì´ì–¸ìŠ¤ ì‹œ)

ë¹„ìš©: $80~138/ì›”
ì¥ì : ì™„ì „í•œ Observability
```

---

## 8. ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Golden Imageì— CloudWatch Agent ì„¤ì¹˜
- [ ] ê¸°ë³¸ ìƒíƒœ: **Disabled**
- [ ] env.tfvarsì— `enable_cloudwatch_agent` ë³€ìˆ˜ ì¶”ê°€
- [ ] user-dataì— ì¡°ê±´ë¶€ í™œì„±í™” ë¡œì§ ì¶”ê°€
- [ ] Dev: Teleport, DBë§Œ í™œì„±í™”
- [ ] Prod: ì „ì²´ ë˜ëŠ” í•„ìˆ˜ë§Œ í™œì„±í™”
- [ ] SNS Topic ìƒì„± (ì•ŒëŒìš©)
- [ ] Slack ì—°ë™ (ì„ íƒ)
