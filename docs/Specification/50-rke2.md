# 50-RKE2 스택 명세서 (Stack Specification)

## 1. 개요 (Overview)
이 스택은 `modules/rke2-cluster`를 호출하여 AWS 환경에 고가용성 RKE2 클러스터를 구축합니다. 기본 인프라(VPC, Subnet) 위에 Control Plane과 Worker Node를 배치하고, Harbor 레지스트리와의 연동을 통해 이미지 캐싱 및 프록시 환경을 구성합니다.

---

## 2. 아키텍처 및 구성 (Architecture & Configuration)

### A. 리소스 구성
- **Control Plane**: 3대 (HA 구성). `etcd`와 API 서버 역할을 수행하며, 내부 NLB를 통해 로드 밸런싱됩니다.
- **Worker Node**: 4대. 실제 워크로드가 실행되는 데이터 플레인입니다.
- **Internal NLB**:
  - API Server (6443) 및 Registration Server (9345) 로드 밸런싱.
  - VPC 내부에서만 접근 가능하도록 `internal` 스키마 사용.
- **Security Group**: 노드 간 통신, Ingress/VPC 내부 접근을 허용합니다.

### B. 주요 파라미터 (Variables)
| 변수명 | 설정값 (Dev) | 설명 |
|:---|:---|:---|
| `rke2_version` | `v1.31.6+rke2r1` | Rancher 2.10 호환 최신 버전. |
| `enable_internal_nlb` | `true` | API 서버용 내부 NLB 필수 사용. |
| `enable_public_ingress_nlb` | **`false`** | (중요) Ingress용 Public NLB 생성 비활성화. |
| `enable_acm_tls_termination` | **`false`** | (중요) NLB 레벨 TLS Termination 비활성화. |
| `harbor_registry_hostport` | `harbor.internal:80` | 내부 Harbor 레지스트리 엔드포인트. |

---

## 3. 구현 의도 및 디자인 의사결정 (Design Rationale)

### A. Public Ingress NLB 및 ACM 비활성화 (`false`)
**설정:**
- `enable_public_ingress_nlb = false`
- `enable_acm_tls_termination = false`

**의도 (Rationale):**
초기 아키텍처에서는 인프라 단계(`50-rke2`)에서 NLB와 ACM을 생성하여 트래픽을 처리하려 했으나, **GitOps 중심의 아키텍처로 전환**하면서 이를 변경했습니다.
1.  **Ingress Controller의 동적 관리**: Ingress Controller(Nginx)는 `55-bootstrap` 단계에서 ArgoCD에 의해 배포됩니다. 이때 `LoadBalancer` 타입의 서비스를 생성하면, AWS Load Balancer Controller(또는 CCM)가 자동으로 NLB를 프로비저닝합니다.
2.  **ACM 인증서의 유연성**: 인프라에 하드코딩된 ACM ARN을 사용하는 대신, 인그레스 컨트롤러가 생성하는 NLB에 어노테이션을 통해 유동적으로 인증서를 붙이거나, Cert-Manager 등을 도입할 확장성을 열어두기 위함입니다.
3.  **책임의 명확한 분리 (Separation of Concerns)**:
    - `50-rke2`는 순수한 "컴퓨팅 리소스(Cluster Environment)" 제공에만 집중합니다.
    - 외부 트래픽을 처리하는 Ingress와 TLS 인증서 관리는 애플리케이션 영역인 `55-bootstrap`으로 완전히 이관했습니다.
    - 이에 따라, 기존에 `50-rke2`에 존재하던 **복잡한 ACM 자동 탐색 로직을 제거**하여 모듈을 경량화하고, 인프라 배포 파이프라인(`init` -> `plan` -> `apply` -> `destroy`)의 안정성을 확보했습니다.

### B. Harbor 레지스트리 프리-풀 (Pre-pull) 및 미러링
**설정:**
- `enable_image_prepull = true`
- `registries.yaml` 미러 설정

**의도 (Rationale):**
클러스터 초기 부트스트래핑 속도를 높이고, 인터넷 대역폭 사용을 최적화하기 위함입니다.
1.  **캐시 웜업**: RKE2 구동에 필요한 시스템 이미지들을 Harbor Proxy Cache를 통해 미리 당겨옴으로써, 이후 Worker 노드들이나 재배포 시 외부 레지스트리(DockerHub 등)가 아닌 로컬 네트워크의 Harbor에서 즉시 이미지를 가져옵니다.
2.  **안정성**: 외부 레지스트리의 장애나 Rate Limit 발생 시에도, 이미 캐싱된 Harbor를 통해 안정적인 배포를 보장합니다.

### C. `count` 대신 `for_each` 사용 및 `moved` 블록 적용
**의도 (Rationale):**
인스턴스 관리의 안정성을 위함입니다.
- `count`를 사용하면 중간 인덱스의 노드가 삭제될 경우 이후 노드들의 인덱스가 밀리면서 전면 재생성(Recreation)되는 위험이 있습니다.
- `for_each`와 고유 키(cp-01, worker-01 등)를 사용하여 특정 노드를 추가/삭제하더라도 다른 노드에 영향을 주지 않도록 설계했습니다.
- 최근 마이그레이션 과정에서 발생한 중복 생성을 방지하기 위해 `moved` 블록을 모듈에 포함하여, 기존 상태 파일이 자연스럽게 새 구조를 따라가도록 조치했습니다.
