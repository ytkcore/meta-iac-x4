# 60-DB 스택 명세서 (Stack Specification)

## 1. 개요 (Overview)
이 스택은 애플리케이션 및 플랫폼(Keycloak, Rancher, Harbor 등)에서 사용하는 **데이터베이스 인스턴스**를 프로비저닝합니다. PostgreSQL과 Neo4j를 지원하며, 환경에 따라 EC2 자체 구축(Self-managed) 또는 AWS RDS/Aurora(Managed)를 선택할 수 있는 유연성을 제공합니다.

---

## 2. 아키텍처 및 구성 (Architecture & Configuration)

### A. 리소스 구성
- **PostgreSQL**:
  - `self` 모드: EC2 위에 Docker 컨테이너 또는 패키지로 설치.
  - `rds` / `aurora` 모드: AWS Managed Database 서비스 사용.
- **Neo4j**:
  - EC2 위에 Standalone으로 구축 (Community Edition).
- **Security**: `10-security`의 공통 SG 및 `00-network`의 DB 서브넷 활용.

### B. 주요 파라미터 (Variables)
| 변수명 | 설정값 (Dev) | 설명 |
|:---|:---|:---|
| `postgres_mode` | `"self"` or `"rds"` | DB 운영 방식 선택. |
| `postgres_image_tag` | `"14.5"` | PostgreSQL 버전. |
| `db_subnet_tier` | `"db"` | 배치할 서브넷 티어. |

---

## 3. 구현 의도 및 디자인 의사결정 (Design Rationale)

### A. 하이브리드 배포 모드 지원 (`postgres_mode`)
**설정:**
- `var.postgres_mode` ("self", "rds", "aurora")

**의도 (Rationale):**
**비용과 안정성 사이의 트레이드오프**를 환경별로 조절하기 위함입니다.
- **Dev/Sandbox**: 비용 절감이 최우선이므로, 비싼 RDS 대신 `t3.micro` 수준의 EC2에 DB를 직접 띄워(`self`) 사용합니다.
- **Staging/Prod**: 데이터 무결성, 백업, 고가용성이 중요하므로 `rds` 또는 `aurora`를 사용하여 운영 부담을 줄입니다.
- 이 모든 것이 단일 Terraform 코드(`60-db`) 내에서 변수 하나로 전환되도록 추상화했습니다.

### B. 랜덤 비밀번호 생성 및 관리
**설정:**
- `resource "random_password"` 사용.

**의도 (Rationale):**
초기 비밀번호를 `env.tfvars`에 평문으로 하드코딩하는 보안 위험을 방지합니다.
- Terraform이 생성한 무작위 비밀번호는 State 파일에 암호화되어 저장되며, 이후 애플리케이션(Kubernetes Secrets 등)에 주입될 때만 참조됩니다.

### C. AMI 선정 (ECS Optimized Image)
**설정:**
- `aws_ssm_parameter`로 ECS Ami 조회.

**의도 (Rationale):**
Standalone DB(EC2) 구동 시, 불필요한 패키지 설치를 줄이고 Docker 데몬이 선탑재된 이미지를 사용하여 **"Immutable Infrastructure"**에 가까운 배포를 하기 위함입니다. 별도의 Ansible/Chef 없이도 `user_data`와 Docker만으로 DB를 빠르게 띄울 수 있습니다.
