#!/bin/bash
# =============================================================================
# Bastion Bootstrap - Pure Jump Host (DevSecOps)
# Purpose: SSM/SSH tunnel endpoint only - no tools installed
# =============================================================================
set -euo pipefail

log() { echo "[bastion] $*"; }

log "Starting minimal bastion setup..."

# -----------------------------------------------------------------------------
# Minimal packages for SSM connectivity
# -----------------------------------------------------------------------------
dnf -y update -q || true
dnf -y install -q curl ca-certificates || true

# -----------------------------------------------------------------------------
# SSM Agent (should be pre-installed on AL2023, ensure running)
# -----------------------------------------------------------------------------
systemctl enable --now amazon-ssm-agent || true

# -----------------------------------------------------------------------------
# Hardening: Disable unnecessary services
# -----------------------------------------------------------------------------
systemctl disable --now postfix 2>/dev/null || true
systemctl disable --now rpcbind 2>/dev/null || true

# -----------------------------------------------------------------------------
# Usage instructions (displayed on SSM login)
# -----------------------------------------------------------------------------
cat > /etc/motd << 'MOTD'
================================================================================
  BASTION HOST - Jump Server Only (DevSecOps)
================================================================================

  This host is for SSM/SSH tunneling only. No kubectl/helm installed.
  
  To access K8s API from your LOCAL machine:
  
  1. Start SSM port-forward tunnel:
     aws ssm start-session --target ${instance_id} \
       --document-name AWS-StartPortForwardingSessionToRemoteHost \
       --parameters '{"host":["${nlb_dns}"],"portNumber":["6443"],"localPortNumber":["6443"]}'
  
  2. Use kubectl locally:
     kubectl --server=https://127.0.0.1:6443 get nodes

================================================================================
MOTD

log "Bastion setup complete (minimal jump host mode)"
