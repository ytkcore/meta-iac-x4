################################################################################
# Monitoring Stack Application (ArgoCD)
#
# kube-prometheus-stack 포함:
# - Prometheus (메트릭 수집)
# - Grafana (시각화)
# - Alertmanager (알림)
# - Node Exporter (노드 메트릭)
# - kube-state-metrics (K8s 리소스 메트릭)
################################################################################
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring
  namespace: argocd
  labels:
    app.kubernetes.io/name: monitoring
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/managed-by: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "30"
    # [UX] Deep Links (Sibling Domains)
    link.argocd.argoproj.io/external-link: "https://grafana.unifiedmeta.net"
    link.argocd.argoproj.io/prometheus: "https://prometheus.unifiedmeta.net"
    link.argocd.argoproj.io/alertmanager: "https://alertmanager.unifiedmeta.net"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: "65.1.0"
    helm:
      releaseName: monitoring
      skipCrds: false
      valuesObject:
        fullnameOverride: monitoring
        
        # ====================================================================
        # 1. Prometheus (Performance & Stability)
        # ====================================================================
        prometheus:
          enabled: true
          prometheusSpec:
            replicas: 1
            # [Optimization] Critical: Reduce I/O load on Longhorn
            walCompression: true
            retention: 15d
            retentionSize: "20Gi"
            
            # [QoS] High Memory Request to prevent OOM
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 1000m
                memory: 2Gi
            
            # [Resiliency] Safe Drain Strategy
            podDisruptionBudget:
              enabled: true
              minAvailable: 1
            
            # [Storage] Cloud Agnostic Persistence
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 20Gi
            
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false

        # ====================================================================
        # 2. Alertmanager (High Availability)
        # ====================================================================
        alertmanager:
          enabled: true
          alertmanagerSpec:
            # [HA] 3-Node Cluster for reliability (Quorum)
            replicas: 3
            # [Resiliency] Force distribution across nodes
            podAntiAffinityTopologyKey: kubernetes.io/hostname
            
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi

        # ====================================================================
        # 3. Grafana (Security, Network & UX)
        # ====================================================================
        grafana:
          enabled: true
          
          # [Security] No Hardcoded Passwords
          admin:
            existingSecret: "monitoring-grafana-secret"
            userKey: admin-user
            passwordKey: admin-password
          
          # [Security] Hardening Config
          grafana.ini:
            auth.anonymous:
              enabled: false
            server:
              root_url: "https://grafana.unifiedmeta.net"

            # [SSO] Keycloak OIDC Integration (Phase 2)
            auth.generic_oauth:
              enabled: true
              name: "Keycloak"
              allow_sign_up: true
              auto_login: false
              client_id: "grafana"
              client_secret: "${KEYCLOAK_GRAFANA_CLIENT_SECRET}"
              scopes: "openid email profile roles"
              auth_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/auth"
              token_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/token"
              api_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/userinfo"
              role_attribute_path: "contains(groups[*], 'admin') && 'Admin' || contains(groups[*], 'editor') && 'Editor' || 'Viewer'"
              tls_skip_verify_insecure: true

          # [Network] Sibling Domain Strategy
          ingress:
            enabled: true
            ingressClassName: nginx
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              # [Security] Clickjacking Protection
              nginx.ingress.kubernetes.io/configuration-snippet: |
                more_set_headers "X-Frame-Options: DENY";
            hosts:
              - grafana.unifiedmeta.net
            tls:
              - secretName: grafana-tls
                hosts:
                  - grafana.unifiedmeta.net

          persistence:
            enabled: true
            storageClassName: longhorn
            size: 5Gi

        # ====================================================================
        # 4. RKE2 Tuning
        # ====================================================================
        kubeControllerManager: { enabled: false }
        kubeScheduler: { enabled: false }
        kubeEtcd: { enabled: false }
        kubeProxy: { enabled: false }
        
        nodeExporter: { enabled: true }
        kubeStateMetrics: { enabled: true }
        kubelet: { enabled: true }
        kubeApiServer: { enabled: true }

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - RespectIgnoreDifferences=true
    # [Stability] Robust Retry for large CRDs
    retry:
      limit: 10
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 10m
  
  ignoreDifferences:
    - group: apps
      kind: DaemonSet
      jsonPointers:
        - /spec/template/metadata
        - /spec/template/spec/containers/0/resources
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/template/metadata
        - /spec/template/spec/containers/0/resources
    - group: monitoring.coreos.com
      kind: Prometheus
      jsonPointers:
        - /spec
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle