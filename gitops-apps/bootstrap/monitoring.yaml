################################################################################
# Monitoring Stack Application (ArgoCD)
#
# kube-prometheus-stack 포함:
# - Prometheus (메트릭 수집)
# - Grafana (시각화)
# - Alertmanager (알림)
# - Node Exporter (노드 메트릭)
# - kube-state-metrics (K8s 리소스 메트릭)
################################################################################
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring
  namespace: argocd
  labels:
    app.kubernetes.io/name: monitoring
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/managed-by: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "30"
    # [UX] Deep Links (Sibling Domains)
    link.argocd.argoproj.io/external-link: "https://grafana.unifiedmeta.net"
    link.argocd.argoproj.io/prometheus: "https://prometheus.unifiedmeta.net"
    link.argocd.argoproj.io/alertmanager: "https://alertmanager.unifiedmeta.net"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: "65.1.0"
    helm:
      releaseName: monitoring
      skipCrds: false
      # [Fix] valuesObject → values (string)
      # ArgoCD RawExtension 파싱 에러 방지
      # "unable to find api field in struct RawExtension for prometheusOperator"
      values: |
        fullnameOverride: monitoring

        # ====================================================================
        # 1. Prometheus (Performance & Stability)
        # ====================================================================
        prometheus:
          enabled: true
          prometheusSpec:
            replicas: 1
            walCompression: true
            retention: 15d
            retentionSize: "20GiB"
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 1000m
                memory: 2Gi
            podDisruptionBudget:
              enabled: true
              minAvailable: 1
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 20Gi
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false
          ingress:
            enabled: true
            ingressClassName: nginx-internal
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
            hosts:
              - prometheus.unifiedmeta.net
            tls:
              - secretName: prometheus-tls
                hosts:
                  - prometheus.unifiedmeta.net

        # ====================================================================
        # 2. Alertmanager (High Availability)
        # ====================================================================
        alertmanager:
          enabled: true
          alertmanagerSpec:
            replicas: 3
            podAntiAffinityTopologyKey: kubernetes.io/hostname
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi
          ingress:
            enabled: true
            ingressClassName: nginx-internal
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
            hosts:
              - alertmanager.unifiedmeta.net
            tls:
              - secretName: alertmanager-tls
                hosts:
                  - alertmanager.unifiedmeta.net

        # ====================================================================
        # 3. Grafana (Security, Network & UX)
        # ====================================================================
        grafana:
          enabled: true
          assertNoLeakedSecrets: false
          admin:
            existingSecret: "monitoring-grafana-secret"
            userKey: admin-user
            passwordKey: admin-password
          grafana.ini:
            auth.anonymous:
              enabled: false
            server:
              root_url: "https://grafana.unifiedmeta.net"
            auth.generic_oauth:
              enabled: true
              name: "Keycloak"
              allow_sign_up: true
              auto_login: false
              client_id: "grafana"
              client_secret: "cb3ac87e35b9560110b2667e43bcc503"
              scopes: "openid email profile roles"
              auth_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/auth"
              token_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/token"
              api_url: "https://keycloak.dev.unifiedmeta.net/realms/platform/protocol/openid-connect/userinfo"
              role_attribute_path: "contains(groups[*], 'admin') && 'Admin' || contains(groups[*], 'editor') && 'Editor' || 'Viewer'"
              tls_skip_verify_insecure: true
          ingress:
            enabled: true
            ingressClassName: nginx-internal
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/configuration-snippet: |
                more_set_headers "X-Frame-Options: DENY";
            hosts:
              - grafana.unifiedmeta.net
            tls:
              - secretName: grafana-tls
                hosts:
                  - grafana.unifiedmeta.net
          # Observability Datasources (Loki + Tempo)
          additionalDataSources:
            - name: Loki
              type: loki
              access: proxy
              url: http://loki-gateway.monitoring.svc.cluster.local
              jsonData:
                derivedFields:
                  - datasourceUid: tempo
                    matcherRegex: '"traceID":"(\w+)"'
                    name: TraceID
                    url: "$${__value.raw}"
              isDefault: false
            - name: Tempo
              type: tempo
              uid: tempo
              access: proxy
              url: http://tempo.monitoring.svc.cluster.local:3100
              jsonData:
                tracesToLogs:
                  datasourceUid: loki
                  filterByTraceID: true
                  filterBySpanID: false
                tracesToMetrics:
                  datasourceUid: prometheus
                serviceMap:
                  datasourceUid: prometheus
                nodeGraph:
                  enabled: true
              isDefault: false
          persistence:
            enabled: true
            storageClassName: longhorn
            size: 5Gi

        # ====================================================================
        # 4. RKE2 Tuning
        # ====================================================================
        kubeControllerManager:
          enabled: false
        kubeScheduler:
          enabled: false
        kubeEtcd:
          enabled: false
        kubeProxy:
          enabled: false
        nodeExporter:
          enabled: true
        kubeStateMetrics:
          enabled: true
        kubelet:
          enabled: true
        kubeApiServer:
          enabled: true

        # ====================================================================
        # 5. Prometheus Operator
        # ====================================================================
        prometheusOperator:
          admissionWebhooks:
            enabled: false

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - RespectIgnoreDifferences=true
      - SkipDryRunOnMissingResource=true
    # [Stability] Robust Retry for large CRDs
    retry:
      limit: 10
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 10m

  ignoreDifferences:
    - group: apps
      kind: DaemonSet
      jsonPointers:
        - /spec/template/metadata
        - /spec/template/spec
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/template/metadata
        - /spec/template/spec
    - group: monitoring.coreos.com
      kind: Prometheus
      jqPathExpressions:
        - .spec
        - .metadata.annotations
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle
    - kind: PersistentVolumeClaim
      jqPathExpressions:
        - .spec