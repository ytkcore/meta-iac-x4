apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-load-balancer-controller
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: https://aws.github.io/eks-charts
    targetRevision: 1.8.4
    chart: aws-load-balancer-controller
    helm:
      values: |
        clusterName: meta-dev-k8s
        region: ap-northeast-2

        # Phase 3: Vault AWS Secrets Engine으로 credential 주입
        # Vault Agent Injector가 STS 임시 자격증명을 /vault/secrets/aws-creds에 렌더링
        podAnnotations:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/agent-inject-status: "update"
          vault.hashicorp.com/role: "albc"
          vault.hashicorp.com/agent-inject-secret-aws-creds: "aws/creds/albc"
          vault.hashicorp.com/agent-inject-template-aws-creds: |
            {{- with secret "aws/creds/albc" -}}
            [default]
            aws_access_key_id={{ .Data.access_key }}
            aws_secret_access_key={{ .Data.secret_key }}
            aws_session_token={{ .Data.security_token }}
            {{- end }}

        # AWS SDK가 Vault Agent가 주입한 credential 파일을 사용하도록 설정
        extraEnv:
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: /vault/secrets/aws-creds

        # VPC ID (ALBC가 서브넷/SG 조회에 필요)
        vpcId: ""

        # NLB IP mode 기본 설정
        enableServiceMutatorWebhook: true

        # Ingress webhook 비활성화: nginx ingress와 공존을 위해
        # ALBC는 NLB target 관리만 담당, Ingress 검증은 불필요
        webhookConfig:
          disableIngressValidation: true

        # Resource limits
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi

        # Node selector: Worker 노드에 배포
        tolerations: []
        nodeSelector: {}

        # Webhook 인증서 (cert-manager 사용)
        enableCertManager: true
  destination:
    server: https://kubernetes.default.svc
    namespace: aws-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
